<?php

require_once __DIR__ . '/../models/location.php';
require_once __DIR__ . '/../../database/database.php';
// LocationController.php
class LocationController {
    private $locationModel;

    public function __construct() {
        $db = new Database();
        $conn = $db->connect();
        $this->locationModel = new LocationModel($conn);
    }

    public function createLocationBySearch() {
        header('Content-Type: application/json');
        $raw = file_get_contents("php://input");
        $data = json_decode($raw, true);

        // Accept either the JS search result shape ({lat, lng, display_name})
        // or a more explicit payload ({latitude, longitude, name, address}).
        $payload = [
            'name' => null,
            'address' => null,
            'latitude' => null,
            'longitude' => null,
            'nominatim_place_id' => null,
            'osm_type' => null,
            'osm_id' => null,
        ];

        if (is_array($data)) {
            // Nominatim client shape
            if (isset($data['lat']) && isset($data['lng'])) {
                $payload['name'] = $data['display_name'] ?? ($data['name'] ?? null);
                $payload['address'] = $data['display_name'] ?? ($data['address'] ?? null);
                $payload['latitude'] = $data['lat'];
                $payload['longitude'] = $data['lng'];
                $payload['nominatim_place_id'] = $data['nominatim_place_id'] ?? null;
                $payload['osm_type'] = $data['osm_type'] ?? null;
                $payload['osm_id'] = $data['osm_id'] ?? null;
            } else {
                // explicit shape
                $payload['name'] = $data['name'] ?? null;
                $payload['address'] = $data['address'] ?? null;
                $payload['latitude'] = $data['latitude'] ?? null;
                $payload['longitude'] = $data['longitude'] ?? null;
                $payload['nominatim_place_id'] = $data['nominatim_place_id'] ?? null;
                $payload['osm_type'] = $data['osm_type'] ?? null;
                $payload['osm_id'] = $data['osm_id'] ?? null;
            }
        }

        // Basic validation
        if (empty($payload['name']) || !isset($payload['latitude']) || !isset($payload['longitude'])) {
            http_response_code(400);
            echo json_encode(['error' => 'Invalid input - name, latitude and longitude are required']);
            return;
        }

        // Call the model method that exists in LocationModel
        $locationId = $this->locationModel->createLocationBySearch($payload);
        if ($locationId) {
            http_response_code(201); // Created
            echo json_encode(['message' => 'Location created successfully', 'location_id' => (int)$locationId]);
        } else {
            http_response_code(500);
            echo json_encode(['error' => 'Failed to create location']);
        }

    }

    public function deleteLocationByName() {
        $raw = file_get_contents("php://input");
        $data = json_decode($raw, true);
        // Basic validation if 'id' field is present and not empty
        if (!isset($data['id']) || empty(trim($data['id']))) {
            http_response_code(400);
            echo json_encode(['error' => 'ID is required']);
            return;
        }
        // Call model to delete location (assuming deleteLocation method exists)
        $deleted = $this->locationModel->deleteLocationByName($data['id']);
        if ($deleted) {
            http_response_code(200); // OK
            echo json_encode(['message' => 'Location deleted successfully']);
        } else {
            http_response_code(500);
            echo json_encode(['error' => 'Failed to delete location']);
        }
    }
}

// simple routing logic
if (isset($_GET['action'])) {
    $controller = new LocationController();
    if ($_GET['action'] === 'createLocation') {
        $controller->createLocationBySearch();
    } elseif ($_GET['action'] === 'deleteLocation') {
        $controller->deleteLocationByName();
    }
}